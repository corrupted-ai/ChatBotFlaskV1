<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Chatbot</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>

<body style="background: linear-gradient(135deg, #232526 0%, #414345 100%); min-height: 100vh;" class="text-light">

  <!-- Navbar -->
  <nav class="navbar navbar-dark bg-black shadow-sm rounded-bottom px-2"
    style="padding: 0; min-height:50px; height:50px;">
    <div class="container-fluid d-flex justify-content-between align-items-center"
      style="min-height:50px; height:50px;">
      <a class="navbar-brand m-0 p-0" href="#" style="height: 100%;">
        <img src="{{ url_for('static', filename='images/CompanyLogo.png') }}" height="32" alt="Company Logo"
          style="display:block;">
      </a>
      <div class="mx-auto text-center flex-grow-1">
        <span class="navbar-title fw-bold fs-5 text-light" style="letter-spacing:1px;">Store Assistant</span>
      </div>
      <div style="width:32px;"></div>
    </div>
  </nav>

  <div class="container-fluid d-flex flex-column"
    style="height: calc(100vh - 50px); min-height: 0; padding-top: 0.5rem;">
    <!-- Example Prompts -->
    <div class="mb-4">
      <div class="d-flex align-items-center mb-2">
        <i class="bi bi-stars text-info fs-5 me-2"></i>
        <span class="fw-bold text-info" style="font-size:1.1rem; letter-spacing:0.5px;">Try asking</span>
      </div>
      <div id="examples" class="d-flex flex-wrap gap-2">
        {% for prompt in examples %}
        <button class="btn btn-gradient btn-sm example-btn px-3 py-1" onclick="sendMessageFromExample('{{ prompt }}')">
          <i class="bi bi-lightbulb me-1 text-warning"></i>{{ prompt }}
        </button>
        {% endfor %}
      </div>
    </div>

    <!-- Chat Interface (no card) -->
    <div id="chatbox" class="flex-grow-1"
      style="min-height: 0; overflow-y: auto; background: #23272b; border-radius: 1rem; width: 100%;">
    </div>
    <div class="chat-input-wrapper mt-2">
      <textarea id="userInput" class="chat-input" placeholder="Type your question..." rows="1"></textarea>
      <div class="d-flex justify-content-between align-items-center mt-2">
        <button id="resetChat" class="btn btn-outline-danger btn-sm px-2 py-1" type="button" style="height:36px;">
          <i class="bi bi-arrow-counterclockwise"></i>
        </button>
        <button id="sendIcon" class="btn btn-info btn-sm ms-2 px-3 py-1" onclick="sendMessage()" type="button" disabled>
          <i class="bi bi-send"></i>
        </button>
      </div>
    </div>
  </div>

  <script>
    let loadingIndicator = null;
    let messageIdCounter = 0;
    let fetchController = null; // For aborting fetch

    async function sendMessage(message = null) {
      const input = document.getElementById('userInput');
      const chatbox = document.getElementById('chatbox');
      let userMessage = (typeof message === 'string') ? message : input.value;
      const sendBtn = document.getElementById('sendIcon');
      const sendIcon = sendBtn.querySelector('i');
      if (!userMessage.trim()) return;

      appendMessage('You', userMessage, 'user');
      input.value = "";
      input.style.height = '44px';

      // Show loading indicator
      loadingIndicator = document.createElement('div');
      loadingIndicator.className = 'message-container bot';
      loadingIndicator.innerHTML = `<div class="chat-message bot-msg"><span class="blinking-dot"></span></div>`;
      chatbox.appendChild(loadingIndicator);
      chatbox.scrollTop = chatbox.scrollHeight;

      // Change send icon to stop
      sendIcon.classList.remove('bi-send');
      sendIcon.classList.add('bi-stop');
      sendBtn.disabled = false;
      sendBtn.onclick = stopMessage;

      // Setup abort controller
      fetchController = new AbortController();

      const ContUserMsg = getChatHistoryForModel();
      console.log('Sending message:', ContUserMsg);
      try {
        const res = await fetch('/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: ContUserMsg }),
          signal: fetchController.signal
        });


        const data = await res.json();
        console.log('Response:', data);

        // Remove loading indicator
        if (loadingIndicator) {
          chatbox.removeChild(loadingIndicator);
          loadingIndicator = null;
        }

        appendMessage('Bot', data[0], 'bot');
      } catch (err) {
        if (err.name === 'AbortError') {
          // User stopped the message
          if (loadingIndicator) {
            chatbox.removeChild(loadingIndicator);
            loadingIndicator = null;
          }
        } else {
          // Handle other errors if needed
        }
      } finally {
        // Restore send icon
        sendIcon.classList.remove('bi-stop');
        sendIcon.classList.add('bi-send');
        sendBtn.onclick = sendMessage;
        fetchController = null;
      }
    }

    function appendMessage(sender, text, type) {
      const chatbox = document.getElementById('chatbox');
      const wrapper = document.createElement('div');
      const msgId = ++messageIdCounter;
      wrapper.classList.add('message-container');
      wrapper.dataset.msgId = msgId;
      if (type === 'bot') {
        wrapper.classList.add('bot');
      } else {
        wrapper.classList.add('user');
      }

      const bubble = document.createElement('div');
      bubble.classList.add('chat-message', type === 'user' ? 'user-msg' : 'bot-msg');
      if (type === 'bot') {
        bubble.innerHTML = marked.parse(text); // Render markdown for bot
      } else {
        bubble.textContent = text; // Plain text for user
      }
      wrapper.appendChild(bubble);

      // Add feedback and regenerate only for bot messages
      if (type === 'bot') {
        const actions = document.createElement('div');
        actions.className = 'message-actions d-flex align-items-center gap-2 mt-1';

        // Feedback buttons
        const thumbsUp = document.createElement('button');
        thumbsUp.className = 'feedback-btn';
        thumbsUp.title = 'Good response';
        thumbsUp.innerHTML = '<i class="bi bi-hand-thumbs-up"></i>';
        thumbsUp.onclick = () => handleFeedback('up', text);

        const thumbsDown = document.createElement('button');
        thumbsDown.className = 'feedback-btn';
        thumbsDown.title = 'Bad response';
        thumbsDown.innerHTML = '<i class="bi bi-hand-thumbs-down"></i>';
        thumbsDown.onclick = () => handleFeedback('down', text);

        // Regenerate button
        const regenBtn = document.createElement('button');
        regenBtn.className = 'regen-btn';
        regenBtn.title = 'Regenerate response';
        regenBtn.innerHTML = '<i class="bi bi-arrow-repeat"></i>';
        regenBtn.onclick = () => regenerateResponse(msgId);

        actions.appendChild(thumbsUp);
        actions.appendChild(thumbsDown);
        actions.appendChild(regenBtn);

        wrapper.appendChild(actions);
      }

      chatbox.appendChild(wrapper);
      chatbox.scrollTop = chatbox.scrollHeight;
    }

    function stopMessage() {
      if (fetchController) {
        fetchController.abort();
      }
    }

    function regenerateResponse(msgId) {
      const chatbox = document.getElementById('chatbox');
      const allMessages = Array.from(chatbox.querySelectorAll('.message-container'));
      const targetIdx = allMessages.findIndex(div => Number(div.dataset.msgId) === msgId);

      if (targetIdx === -1) return;

      // Remove all messages after the one being regenerated
      for (let i = allMessages.length - 1; i > targetIdx; i--) {
        chatbox.removeChild(allMessages[i]);
      }

      // Show loading indicator in place of the bot message
      const botMsgDiv = allMessages[targetIdx];
      const bubble = botMsgDiv.querySelector('.chat-message');
      const originalText = bubble.innerText;
      bubble.innerHTML = `<span class="blinking-dot"></span>`;


      // Fetch new response (simulate with timeout here, replace with your fetch)
      const lastUserMsg = getChatHistoryForModel();
      fetch('/chat', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ message: lastUserMsg })
      })
        .then(res => res.json())
        .then(data => {
          bubble.innerHTML = marked.parse(data[0]);
          console.log('Response:', data);
        });
    }

    // Helper to find the last user message before the given msgId
    function findLastUserMessageBefore(msgId, allMessages) {
      for (let i = allMessages.findIndex(div => Number(div.dataset.msgId) === msgId) - 1; i >= 0; i--) {
        if (allMessages[i].classList.contains('user')) {
          return allMessages[i].querySelector('.chat-message').innerText;
        }
      }
      return '';
    }

    function getChatHistoryForModel(n = 5) {
      const chatbox = document.getElementById('chatbox');
      const allMessages = Array.from(chatbox.querySelectorAll('.message-container'));
      const history = [];

      // Collect last n user and bot messages in order
      for (let i = 0; i < allMessages.length; i++) {
        const msgDiv = allMessages[i];
        const text = msgDiv.querySelector('.chat-message')?.innerText || '';
        if (msgDiv.classList.contains('user')) {
          history.push({ role: 'user', content: text });
        }
        if (msgDiv.classList.contains('bot')) {
          history.push({ role: 'assistant', content: text });
        }
      }

      // Return only the last n user+assistant pairs (up to 2n messages)
      return history.slice(-n * 2);
    }


    function sendMessageFromExample(text) {
      document.getElementById('userInput').value = text;
      // Trigger input event to enable send button and resize textarea if needed
      const event = new Event('input', { bubbles: true });
      document.getElementById('userInput').dispatchEvent(event);
      // Send the message as if the user typed it
      sendMessage(text);
    }

    const userInput = document.getElementById('userInput');
    const sendIcon = document.getElementById('sendIcon');

    userInput.addEventListener('input', function () {
      this.style.height = 'auto';
      this.style.height = Math.min(this.scrollHeight, 160) + 'px';
      sendIcon.disabled = !this.value.trim();
      // sendIcon.style.display = this.value.trim() ? 'flex' : 'none';
    });

    userInput.addEventListener('keydown', function (e) {
      if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        if (this.value.trim()) sendMessage();
      }
      // Shift+Enter will insert a new line by default, so no code needed for that
    });

    function handleFeedback(type, message) {
      // You can send this info to your backend if needed
      alert(`Feedback: ${type === 'up' ? '👍' : '👎'} for "${message}"`);
    }

    document.getElementById('resetChat').onclick = function () {
      document.getElementById('chatbox').innerHTML = '';
      document.getElementById('userInput').value = '';
      document.getElementById('userInput').style.height = '44px';
      document.getElementById('sendIcon').disabled = true;
      // Optionally reset messageIdCounter if you want:
      // messageIdCounter = 0;
    };

  </script>

</body>

</html>